# ontaptx3.ipynb
# Bài: Dự đoán giá nhà (Real Estate Valuation)

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error

# 1. Đọc dữ liệu từ file có sẵn
# Giả sử bạn có file: Real_estate.csv
data = pd.read_csv('Real_estate.csv')

# 2. Xem thông tin dữ liệu
print("\n--- Thông tin dữ liệu ---")
print(data.info())
print("\n--- 5 dòng đầu ---")
print(data.head())

# Đổi tên cột (nếu cần) cho dễ xử lý
data.columns = [
    'No', 'X1_transaction_date', 'X2_house_age', 'X3_distance_to_MRT',
    'X4_convenience_stores', 'X5_latitude', 'X6_longitude', 'Y_house_price'
]

# 3. Trực quan hóa dữ liệu
plt.figure(figsize=(6,4))
plt.scatter(data['X2_house_age'], data['Y_house_price'], color='teal', alpha=0.6)
plt.title('Biểu đồ giữa tuổi nhà và giá nhà')
plt.xlabel('Tuổi nhà (năm)')
plt.ylabel('Giá nhà (10.000 NTD/ping)')
plt.grid(True)
plt.show()

# Biểu đồ vị trí nhà (vĩ độ - kinh độ) theo giá
plt.figure(figsize=(6,5))
plt.scatter(data['X6_longitude'], data['X5_latitude'], c=data['Y_house_price'], cmap='plasma', s=60)
plt.colorbar(label='Giá nhà (10k NTD/ping)')
plt.title('Phân bố vị trí và giá nhà')
plt.xlabel('Kinh độ')
plt.ylabel('Vĩ độ')
plt.show()

# 4. Chia tập train/test
y = data['Y_house_price']
X = data[['X2_house_age', 'X3_distance_to_MRT', 'X4_convenience_stores', 'X5_latitude', 'X6_longitude']]

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# 5. Huấn luyện mô hình Linear Regression
model = LinearRegression()
model.fit(X_train, y_train)

# 6. Đánh giá mô hình
y_pred = model.predict(X_test)
mse = mean_squared_error(y_test, y_pred)
print(f"\nMSE trên tập test: {mse:.2f}")

print("\n--- Hệ số hồi quy ---")
for feature, coef in zip(X.columns, model.coef_):
    print(f"{feature}: {coef:.4f}")
print(f"Intercept: {model.intercept_:.4f}")

# 7. Biểu đồ so sánh kết quả dự đoán
plt.figure(figsize=(6,4))
plt.scatter(y_test, y_pred, color='purple', alpha=0.7)
plt.plot([y_test.min(), y_test.max()], [y_test.min(), y_test.max()], 'r--')
plt.xlabel('Giá thực tế')
plt.ylabel('Giá dự đoán')
plt.title('So sánh giá thực tế và dự đoán')
plt.grid(True)
plt.show()

# 8. Tối ưu mô hình nếu MSE > 80
if mse > 80:
    print("\nMSE > 80, tiến hành chuẩn hóa dữ liệu để tối ưu.")
    from sklearn.preprocessing import StandardScaler
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(X)
    X_train_s, X_test_s, y_train_s, y_test_s = train_test_split(X_scaled, y, test_size=0.2, random_state=42)

    model2 = LinearRegression()
    model2.fit(X_train_s, y_train_s)
    y_pred2 = model2.predict(X_test_s)
    mse2 = mean_squared_error(y_test_s, y_pred2)
    print(f"MSE sau chuẩn hóa: {mse2:.2f}")
else:
    print("\nMô hình đã đạt yêu cầu (MSE < 80).")
